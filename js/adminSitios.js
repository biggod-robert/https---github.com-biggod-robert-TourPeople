$(document).ready(function(){var e=0,i=1,t=[];tabla_sitios=$("#tabla_sitios").DataTable({ajax:{url:"../controller/adminSitios.php",method:"POST",data:{opcion:i},dataSrc:""},columns:[{data:"id_sitio"},{data:"nombre"},{defaultContent:"<div class='multi-button mx-auto'><button><i class='fas fa-trash deleteEvento'></i></button><button><i class='fa-regular fa-pen-to-square editSitio'></i></button></div>",className:"align-middle text-center text-sm td-respon"},],order:[[0,"desc"]],responsive:{details:{display:$.fn.dataTable.Responsive.display.childRowImmediate,type:"none",target:""}}}),$(".addsitio").click(function(e){e.preventDefault(),i=2,r(),$("#titulo-modal").text("Nuevo Sitio"),$("#imgPortada").attr("required",!0),$("#modalSitio").modal("show")}),$("#imgPortada").on("change",function(){let e=this.files[0];if(e){let i=new FileReader;i.onload=function(e){$(".previewImgPortada").empty();let i=$("<img>").attr("src",e.target.result);$(".previewImgPortada").append(i)},i.readAsDataURL(e)}}),$(".cap-img").click(function(){if(e<6){var i=$("<input>").attr({type:"file",accept:"image/*",name:"imagen[]",id:"imgUploas"+e,multiple:!0}).css("display","none");$("#formSitios").append(i),i.change(function(){var i=this.files,a=i.length;if(e+a>6)alert("Solo se permiten hasta 6 im\xe1genes.");else for(var r=0;r<a;r++){var o=i[r];t.push(o);var s=new FileReader;s.onload=function(i){var t=i.target.result,a=$("<img>").attr({src:t,class:"img-thumbnail imgEvide"}),r=$("<i>").addClass("fas fa-trash-alt detelete-img-upload btnDelete").attr("data-index",e),o=$("<div>").addClass("contImgUP").append(a,r),s=$("<div>").addClass("col-md-4 d-flex").append(o);$("#cont-previu").append(s),e++,$(".cap-img").attr("imgCapturadas",e),$(".previewEvide").removeClass("igmError"),$(".cap-img").removeClass("igmErrorCap"),$(".imgEvide").click(function(){var e=$(this).attr("src");$("#imgFullViewSRC").attr("src",e),$(".viewFullImg").removeClass("esconder")}),$(".c-full-view").click(function(){$(".viewFullImg").addClass("esconder")})},s.readAsDataURL(o)}}),i.click()}else alert("No se pueden agregar m\xe1s de 6 im\xe1genes.")}),$("#cont-previu").on("click",".detelete-img-upload",function(){var i,a,r=$(this).attr("data-index");t.splice(r,1),$(this).closest(".col-md-4").remove(),e--,$(".cap-img").attr("imgCapturadas",e),$('input[type="file"][name="imagen[]"]').remove(),i=$("<input>").attr({type:"file",accept:"image/*",name:"imagen[]",multiple:!0}).css("display","none"),$("#formSitios").append(i),a=new DataTransfer,t.forEach(function(e){a.items.add(e)}),i[0].files=a.files});let a=new Quill("#editorDescripcion",{modules:{syntax:!0,toolbar:"#toolbar-container"},placeholder:"Escribe tu sitio",theme:"snow"});function r(){$("#formSitios")[0].reset(),$(".previewImgPortada").empty(),$("#cont-previu").empty(),t=[],e=0,a.setContents([]),$("#imgPortada").attr("required",!0)}$("#formSitios").submit(function(t){if(t.preventDefault(),0==e){$(".cap-img").addClass("igmErrorCap"),$(".previewEvide").addClass("igmErrorCap"),setTimeout(()=>{$(".cap-img").removeClass("igmErrorCap"),$(".previewEvide").removeClass("igmErrorCap")},3500),Swal.fire({title:"Advertencia",text:"Debes de seleccionar de 1 a 6 im\xe1genes",icon:"warning"});return}if(0===a.getText().trim().length){$("#editorDescripcion").addClass("igmErrorCap"),Swal.fire({title:"Advertencia",text:"La descripci\xf3n de la sitio es obligatoria",icon:"warning"}),setTimeout(()=>{$("#editorDescripcion").removeClass("igmErrorCap")},3500);return}let r=document.getElementById("formSitios"),o=new FormData(r),s=a.getContents();o.append("opcion",i),o.append("descripcion",JSON.stringify(s)),$.ajax({type:"POST",url:"../controller/adminSitios.php",data:o,cache:!1,contentType:!1,processData:!1,beforeSend:function(){$("#loader").removeClass("esconder"),$("body").addClass("hidenn")},success:function(e){var i=JSON.parse(e);tabla_sitios.ajax.reload(),$("#modalSitio").modal("hide"),$("#loader").addClass("esconder"),$("body").removeClass("hidenn"),1==i.codigo?Swal.fire({icon:"success",title:"EXITO",html:i.mensaje}):Swal.fire({icon:"error",title:"Ooops.",html:i.mensaje})}})}),$(".c-full-view").click(function(){$(".viewFullImg").addClass("esconder")}),$(document).on("click",".editSitio",function(o){o.preventDefault();var s=$(this).closest("tr");s.hasClass("child")&&(s=s.prev());var n=tabla_sitios.row(s).data().id_sitio;i=3,$("#titulo-modal").text("Editar Sitio"),r(),$("#imgPortada").removeAttr("required"),$.ajax({type:"POST",url:"../controller/adminSitios.php",data:{opcion:i,idSitio:n},beforeSend:function(){$("#loader").removeClass("esconder"),$("body").addClass("hidenn")},success:function(r){try{var o=JSON.parse(r);if(1===o.codigo&&o.data){var s=o.data;$("#id_sitioEdit").val(s.id_sitio),$("#nombreSitio").val(s.nombre),$("#direccion").val(s.ubi_sitio),$("#enlace_reservas").val(s.enlace_reservas_turs),a.setContents(JSON.parse(s.descripcion));var n="../upload/sitios/portadas/"+s.imgPortada;$(".previewImgPortada").html('<img src="'+n+'" class="img-thumbnail">'),s.imagenes.forEach(function(i,a){var r=`
                            <div class="col-md-4 d-flex">
                                <div class="contImgUP">
                                    <img src="${"../upload/sitios/images/"+i.img}" class="img-thumbnail imgEvide">
                                    <i class="fas fa-trash-alt deteleteimgDB btnDelete" data-id="${i.id_img}"></i>
                                </div>
                            </div>`;$("#cont-previu").append(r),e++,t.push(i.img)}),i=5,$("#loader").addClass("esconder"),$("body").removeClass("hidenn")}}catch(d){console.error("Error al decodificar JSON: ",d,r)}}}),$("#modalSitio").modal("show")}),$("#cont-previu").on("click",".deteleteimgDB",function(){var e=$(this).attr("data-id"),i=$(this);$.ajax({type:"POST",url:"../controller/adminSitios.php",data:{opcion:4,idImagen:e},beforeSend:function(){$("#loader").removeClass("esconder"),$("body").addClass("hidenn")},success:function(e){try{var t=JSON.parse(e);1===t.codigo?(i.closest(".col-md-4").remove(),Swal.fire({icon:"success",title:"EXITO",text:t.mensaje})):Swal.fire({icon:"error",title:"Error",text:t.mensaje})}catch(a){console.error("Error al decodificar JSON: ",a,e),Swal.fire({icon:"error",title:"Error",text:"Error en la respuesta del servidor."})}$("#loader").addClass("esconder"),$("body").removeClass("hidenn")},error:function(e,i,t){console.error("Error en la petici\xf3n AJAX: ",t),Swal.fire({icon:"error",title:"Error",text:"Ocurri\xf3 un error al intentar eliminar la imagen."}),$("#loader").addClass("esconder"),$("body").removeClass("hidenn")}})}),$(document).on("click",".deleteEvento",function(e){e.preventDefault();var i=$(this).closest("tr");i.hasClass("child")&&(i=i.prev());var t=tabla_sitios.row(i).data().id_sitio;Swal.fire({title:"\xbfEst\xe1s seguro?",text:"\xa1Esta sitio se eliminar\xe1 permanentemente!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"S\xed, eliminar",cancelButtonText:"Cancelar"}).then(e=>{e.isConfirmed&&$.ajax({type:"POST",url:"../controller/adminSitios.php",data:{opcion:6,idSitioDelete:t},beforeSend:function(){$("#loader").removeClass("esconder"),$("body").addClass("hidenn")},success:function(e){$("#loader").addClass("esconder"),$("body").removeClass("hidenn");var t=JSON.parse(e);1===t.codigo?(tabla_sitios.row(i).remove().draw(),Swal.fire({icon:"success",title:"\xc9xito",text:t.mensaje})):Swal.fire({icon:"error",title:"Error",text:t.mensaje})},error:function(e,i,t){$("#loader").addClass("esconder"),$("body").removeClass("hidenn"),Swal.fire({icon:"error",title:"Error",text:"Error en la solicitud: "+i+" - "+t})}})})})});