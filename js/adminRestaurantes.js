$(document).ready((function(){var e=0,a=1,t=[];tabla_restaurantes=$("#tabla_restaurantes").DataTable({ajax:{url:"../controller/adminRestaurantes.php",method:"POST",data:{opcion:a},dataSrc:""},columns:[{data:"id_restaurante"},{data:"nombre"},{data:"ubi_restaurante"},{defaultContent:"<div class='multi-button mx-auto'><button><i class='fas fa-trash deleteRestaurante'></i></button><button><i class='fa-regular fa-pen-to-square editRestaurante'></i></button></div>",className:"align-middle text-center text-sm td-respon"}],order:[[0,"desc"]],responsive:{details:{display:$.fn.dataTable.Responsive.display.childRowImmediate,type:"none",target:""}}}),$(".addRestaurante").click((function(e){e.preventDefault(),a=2,n(),$("#titulo-modal").text("Nuevo Restaurante"),$("#imgPortada").attr("required",!0),$("#modalRestaurante").modal("show")})),$("#imgPortada").on("change",(function(){const e=this.files[0];if(e){const a=new FileReader;a.onload=function(e){$(".previewImgPortada").empty();const a=$("<img>").attr("src",e.target.result);$(".previewImgPortada").append(a)},a.readAsDataURL(e)}})),$(".cap-img").click((function(){if(e<6){var a=$("<input>").attr({type:"file",accept:"image/*",name:"imagen[]",id:"imgUploas"+e,multiple:!0}).css("display","none");$("#formRestaurantes").append(a),a.change((function(){var a=this.files,r=a.length;if(e+r>6)alert("Solo se permiten hasta 6 imágenes.");else for(var n=0;n<r;n++){var s=a[n];t.push(s);var i=new FileReader;i.onload=function(a){var t=a.target.result,r=$("<img>").attr({src:t,class:"img-thumbnail imgEvide"}),n=$("<i>").addClass("fas fa-trash-alt detelete-img-upload btnDelete").attr("data-index",e),s=$("<div>").addClass("contImgUP").append(r,n),i=$("<div>").addClass("col-md-4 d-flex").append(s);$("#cont-previu").append(i),e++,$(".cap-img").attr("imgCapturadas",e),$(".previewEvide").removeClass("igmError"),$(".cap-img").removeClass("igmErrorCap"),$(".imgEvide").click((function(){var e=$(this).attr("src");$("#imgFullViewSRC").attr("src",e),$(".viewFullImg").removeClass("esconder")}))},i.readAsDataURL(s)}})),a.click()}else alert("No se pueden agregar más de 6 imágenes.")})),$("#cont-previu").on("click",".detelete-img-upload",(function(){var a=$(this).attr("data-index");t.splice(a,1),$(this).closest(".col-md-4").remove(),e--,$(".cap-img").attr("imgCapturadas",e),function(){$('input[type="file"][name="imagen[]"]').remove();var e=$("<input>").attr({type:"file",accept:"image/*",name:"imagen[]",multiple:!0}).css("display","none");$("#formRestaurantes").append(e);var a=new DataTransfer;t.forEach((function(e){a.items.add(e)})),e[0].files=a.files}()}));const r=new Quill("#editorDescripcion",{modules:{syntax:!0,toolbar:"#toolbar-container"},placeholder:"Escribe la descripción del restaurante",theme:"snow"});function n(){$("#formRestaurantes")[0].reset(),$(".previewImgPortada").empty(),$("#cont-previu").empty(),t=[],e=0,r.setContents([]),$("#imgPortada").attr("required",!0)}$("#formRestaurantes").submit((function(t){if(t.preventDefault(),0==e)return $(".cap-img").addClass("igmErrorCap"),$(".previewEvide").addClass("igmErrorCap"),setTimeout((()=>{$(".cap-img").removeClass("igmErrorCap"),$(".previewEvide").removeClass("igmErrorCap")}),3500),void Swal.fire({title:"Advertencia",text:"Debes de seleccionar de 1 a 6 imágenes",icon:"warning"});if(0===r.getText().trim().length)return $("#editorDescripcion").addClass("igmErrorCap"),Swal.fire({title:"Advertencia",text:"La descripción del restaurante es obligatoria",icon:"warning"}),void setTimeout((()=>{$("#editorDescripcion").removeClass("igmErrorCap")}),3500);const n=document.getElementById("formRestaurantes"),s=new FormData(n);let i=r.getContents();s.append("opcion",a),s.append("descripcion",JSON.stringify(i)),$.ajax({type:"POST",url:"../controller/adminRestaurantes.php",data:s,cache:!1,contentType:!1,processData:!1,beforeSend:function(){$("#loader").removeClass("esconder"),$("body").addClass("hidenn")},success:function(e){var a=JSON.parse(e);tabla_restaurantes.ajax.reload(),$("#modalRestaurante").modal("hide"),$("#loader").addClass("esconder"),$("body").removeClass("hidenn"),1==a.codigo?Swal.fire({icon:"success",title:"EXITO",html:a.mensaje}):Swal.fire({icon:"error",title:"Ooops.",html:a.mensaje})}})})),$(".c-full-view").click((function(){$(".viewFullImg").addClass("esconder")})),$(document).on("click",".editRestaurante",(function(s){s.preventDefault();var i=$(this).closest("tr");i.hasClass("child")&&(i=i.prev());var o=tabla_restaurantes.row(i).data().id_restaurante;a=3,$("#titulo-modal").text("Editar Restaurante"),n(),$("#imgPortada").removeAttr("required"),$.ajax({type:"POST",url:"../controller/adminRestaurantes.php",data:{opcion:a,idRestaurante:o},beforeSend:function(){$("#loader").removeClass("esconder"),$("body").addClass("hidenn")},success:function(n){try{var s=JSON.parse(n);if(1===s.codigo&&s.data){var i=s.data;$("#id_restauranteEdit").val(i.id_restaurante),$("#nombreRestaurante").val(i.nombre),$("#ubicacion").val(i.ubi_restaurante),$("#enlace_reservas").val(i.enlace_reservas_rest),r.setContents(JSON.parse(i.descripcion_restaurante));var o="../upload/restaurantes/portadas/"+i.foto;$(".previewImgPortada").html('<img src="'+o+'" class="img-thumbnail">'),i.imagenes.forEach((function(a,r){var n=`\n                            <div class="col-md-4 d-flex">\n                                <div class="contImgUP">\n                                    <img src="${"../upload/restaurantes/images/"+a.img}" class="img-thumbnail imgEvide">\n                                    <i class="fas fa-trash-alt deteleteimgDB btnDelete" data-id="${a.id_img}"></i>\n                                </div>\n                            </div>`;$("#cont-previu").append(n),e++,t.push(a.img)})),a=5,$("#loader").addClass("esconder"),$("body").removeClass("hidenn")}}catch(e){console.error("Error al decodificar JSON: ",e,n)}}}),$("#modalRestaurante").modal("show")})),$("#cont-previu").on("click",".deteleteimgDB",(function(){var e=$(this).attr("data-id"),a=$(this);$.ajax({type:"POST",url:"../controller/adminRestaurantes.php",data:{opcion:4,idImagen:e},beforeSend:function(){$("#loader").removeClass("esconder"),$("body").addClass("hidenn")},success:function(e){try{var t=JSON.parse(e);1===t.codigo?(a.closest(".col-md-4").remove(),Swal.fire({icon:"success",title:"EXITO",text:t.mensaje})):Swal.fire({icon:"error",title:"Error",text:t.mensaje})}catch(a){console.error("Error al decodificar JSON: ",a,e),Swal.fire({icon:"error",title:"Error",text:"Error en la respuesta del servidor."})}$("#loader").addClass("esconder"),$("body").removeClass("hidenn")},error:function(e,a,t){console.error("Error en la petición AJAX: ",t),Swal.fire({icon:"error",title:"Error",text:"Ocurrió un error al intentar eliminar la imagen."}),$("#loader").addClass("esconder"),$("body").removeClass("hidenn")}})})),$(document).on("click",".deleteRestaurante",(function(e){e.preventDefault();var a=$(this).closest("tr");a.hasClass("child")&&(a=a.prev());var t=tabla_restaurantes.row(a).data().id_restaurante;Swal.fire({title:"¿Estás seguro?",text:"¡Este restaurante se eliminará permanentemente!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"}).then((e=>{e.isConfirmed&&$.ajax({type:"POST",url:"../controller/adminRestaurantes.php",data:{opcion:6,idRestauranteDelete:t},beforeSend:function(){$("#loader").removeClass("esconder"),$("body").addClass("hidenn")},success:function(e){$("#loader").addClass("esconder"),$("body").removeClass("hidenn");var t=JSON.parse(e);1===t.codigo?(tabla_restaurantes.row(a).remove().draw(),Swal.fire({icon:"success",title:"Éxito",text:t.mensaje})):Swal.fire({icon:"error",title:"Error",text:t.mensaje})},error:function(e,a,t){$("#loader").addClass("esconder"),$("body").removeClass("hidenn"),Swal.fire({icon:"error",title:"Error",text:"Error en la solicitud: "+a+" - "+t})}})}))}))}));